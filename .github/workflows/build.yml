name: Build PHP PPA

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    name: Build PHP packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      max-parallel: 1
      matrix:
        #distro: [ focal, jammy ]
        distro: [ focal ]
        php: [ "8.3" ]
    container:
      image: ubuntu:${{ matrix.distro }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set noninteractive apt env
        run: |
          echo 'DEBIAN_FRONTEND=noninteractive' >> "$GITHUB_ENV"
          echo 'TZ=Etc/UTC' >> "$GITHUB_ENV"

      - name: Install base dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends ca-certificates gnupg software-properties-common curl wget

      - name: Fetch PHP source on jammy
        if: matrix.distro != 'jammy'
        uses: addnab/docker-run-action@v3
        with:
          image: ubuntu:jammy
          options: -v ${{ github.workspace }}/scripts:/scripts -v ${{ github.workspace }}/artifacts/source:/out
          run: bash /scripts/fetch-php-source.sh "${{ matrix.php }}" /out

      - name: Build PHP
        run: |
          mkdir -p artifacts/${{ matrix.distro }}/${{ matrix.php }}
          if [ "${{ matrix.distro }}" != "jammy" ] && [ -d artifacts/source ]; then
            cp -r artifacts/source/php* .
          fi
          bash scripts/build-php.sh "${{ matrix.distro }}" "${{ matrix.php }}" "artifacts/${{ matrix.distro }}/${{ matrix.php }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php }}-${{ matrix.distro }}
          path: artifacts/${{ matrix.distro }}/${{ matrix.php }}

  publish:
    name: Publish APT repo to pages
    runs-on: ubuntu-latest
    needs: build
    env:
      APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
      APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
      APT_GPG_KEY_ID: ${{ secrets.APT_GPG_KEY_ID }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: _artifacts

      - name: Install reprepro
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends reprepro gnupg

      - name: Import GPG key
        if: ${{ env.APT_GPG_PRIVATE_KEY != '' }}
        run: |
          mkdir -p "$HOME/.gnupg"
          chmod 700 "$HOME/.gnupg"
          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
          echo "passphrase=$APT_GPG_PASSPHRASE" > "$HOME/.gnupg/gpg-agent.conf" || true
          gpgconf --kill gpg-agent || true

      - name: Prepare repo structure
        run: |
          set -e
          # Ensure we are on pages branch (create if missing)
          if git ls-remote --exit-code --heads origin pages >/dev/null 2>&1; then
            git checkout pages
          else
            git checkout --orphan pages
          fi
          mkdir -p repo/conf
          # Generate distributions with optional signing
          cat > repo/conf/distributions <<EOF
          Origin: GitHub Pages PHP PPA
          Label: gh-pages-php-ppa
          Suite: stable
          Codename: focal
          Architectures: amd64 source
          Components: main
          Description: PHP packages built via GitHub Actions for Ubuntu 20.04
          EOF
          if [[ -n "${APT_GPG_KEY_ID}" ]]; then
            echo "SignWith: ${APT_GPG_KEY_ID}" >> repo/conf/distributions
          fi
          cat >> repo/conf/distributions <<EOF

          Origin: GitHub Pages PHP PPA
          Label: gh-pages-php-ppa
          Suite: stable
          Codename: jammy
          Architectures: amd64 source
          Components: main
          Description: PHP packages built via GitHub Actions for Ubuntu 22.04
          EOF
          if [[ -n "${APT_GPG_KEY_ID}" ]]; then
            echo "SignWith: ${APT_GPG_KEY_ID}" >> repo/conf/distributions
          fi

      - name: Add packages to APT repo
        run: |
          set -e
          # Create incoming directory
          mkdir -p incoming
          # Copy artifacts into incoming keeping distro separation
          find _artifacts -type f -name "*.deb" -print0 | xargs -0 -I{} cp -t incoming {}
          # Include packages into correct codename based on artifact folder names
          for deb in incoming/*.deb; do
            # Try to infer codename from original artifact path
            srcpath=$(find _artifacts -type f -name "$(basename "$deb")" | head -n1)
            codename=""
            if echo "$srcpath" | grep -q "/focal/"; then codename="focal"; fi
            if echo "$srcpath" | grep -q "/jammy/"; then codename="jammy"; fi
            # Fallback: default to jammy if unknown
            if [[ -z "$codename" ]]; then codename="jammy"; fi
            reprepro -b repo includedeb "$codename" "$deb"
          done

      - name: Export public key
        run: |
          # Export ASCII-armored public key to KEY.gpg
          if gpg --list-keys | grep -q .; then
            gpg --armor --export > repo/KEY.gpg || true
          fi

      - name: Commit and push to pages
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add repo
          git commit -m "Publish APT repo $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes to commit"
          git push origin pages
